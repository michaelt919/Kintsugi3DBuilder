package openGL.wrappers.implementations;

import static openGL.OpenGLHelper.openGLErrorCheck;
import static org.lwjgl.opengl.GL11.*;
import static org.lwjgl.opengl.GL30.*;

import java.util.AbstractCollection;

import openGL.exceptions.OpenGLInvalidFramebufferOperationException;
import openGL.wrappers.interfaces.FramebufferAttachment;
import openGL.wrappers.interfaces.FramebufferObject;

public class OpenGLFramebufferObject extends OpenGLFramebuffer implements FramebufferObject
{
	private int fboId;
	private AbstractCollection<FramebufferAttachment> attachments;
	
	public OpenGLFramebufferObject(int colorAttachments, boolean depthAttachment, boolean stencilAttachment, boolean combineDepthAndStencil)
	{
		this.fboId = glGenFramebuffers();
		openGLErrorCheck();
		
		if (colorAttachments < 0)
		{
			throw new IllegalArgumentException("The number of color attachments cannot be negative.");
		}
		
		if (colorAttachments > GL_MAX_COLOR_ATTACHMENTS)
		{
			throw new IllegalArgumentException("Too many color attachments specified - maximum is " + GL_MAX_COLOR_ATTACHMENTS + ".");
		}
		
		if (colorAttachments == 0 && !depthAttachment && !stencilAttachment)
		{
			throw new IllegalArgumentException("No attachments specified - every FBO must have at least one attachment.");
		}
		
		for (int i = 0; i < colorAttachments; i++)
		{
			FramebufferAttachment attachment = new OpenGLRenderbuffer();
			glBindFramebuffer(GL_DRAW_FRAMEBUFFER, this.fboId);
			openGLErrorCheck();
			attachment.bindToDrawFramebuffer(GL_COLOR_ATTACHMENT0 + i, 0);
			attachments.add(attachment);
		}
		
		if (depthAttachment && stencilAttachment && combineDepthAndStencil)
		{
			FramebufferAttachment attachment = new OpenGLRenderbuffer();
			glBindFramebuffer(GL_DRAW_FRAMEBUFFER, this.fboId);
			openGLErrorCheck();
			attachment.bindToDrawFramebuffer(GL_DEPTH_STENCIL_ATTACHMENT, 0);
			attachments.add(attachment);
		}
		else
		{
			if (depthAttachment)
			{
				
			}
			
			if (stencilAttachment)
			{
				FramebufferAttachment attachment = new OpenGLRenderbuffer();
				glBindFramebuffer(GL_DRAW_FRAMEBUFFER, this.fboId);
				openGLErrorCheck();
				attachment.bindToDrawFramebuffer(GL_STENCIL_ATTACHMENT, 0);
				attachments.add(attachment);
			}
		}
		
		if(glCheckFramebufferStatus(GL_FRAMEBUFFER) != GL_FRAMEBUFFER_COMPLETE)
		{
			throw new OpenGLInvalidFramebufferOperationException();
		}
		openGLErrorCheck();
	}
	
	private void addAttachment(int attachmentType)
	{
		FramebufferAttachment attachment = new OpenGLRenderbuffer();
		glBindFramebuffer(GL_DRAW_FRAMEBUFFER, this.fboId);
		openGLErrorCheck();
		attachment.bindToDrawFramebuffer(attachmentType, 0);
		attachments.add(attachment);
	}
	
	public OpenGLFramebufferObject(int colorAttachments)
	{
		this(colorAttachments, false, false, false);
	}
	
	public OpenGLFramebufferObject()
	{
		this(1);
	}
	
	@Override
	protected int getId()
	{
		return fboId;
	}

	@Override
	protected void selectColorSourceForRead(int index) 
	{
		glReadBuffer(GL_COLOR_ATTACHMENT0 + index);
		openGLErrorCheck();
	}
	
	@Override
	public void delete()
	{
		glDeleteFramebuffers(this.fboId);
		openGLErrorCheck();
		for (FramebufferAttachment attachment : attachments)
		{
			attachment.delete();
		}
	}
}
