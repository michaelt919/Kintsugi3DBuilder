package openGL.wrappers.implementations;
import static org.lwjgl.opengl.GL11.*;
import static org.lwjgl.opengl.GL20.*;
import static org.lwjgl.opengl.GL40.*;
import Program;
import ProgramLinkFailureException;
import Shader;
import UncompiledShaderException;
import UnlinkedProgramException;

import java.io.File;
import java.io.FileNotFoundException;
import java.util.ArrayList;

public class OpenGLProgram implements Program 
{
	private int programId;
	private ArrayList<Shader> ownedShaders;
	
	public OpenGLProgram()
	{
		initProgram();
	}
	
	public OpenGLProgram(File vertexShader, File fragmentShader) throws FileNotFoundException
	{
		initProgram();
		Shader vertexShaderObj = new OpenGLShader(GL_VERTEX_SHADER, vertexShader);
		Shader fragmentShaderObj = new OpenGLShader(GL_FRAGMENT_SHADER, fragmentShader);
		vertexShaderObj.compile();
		fragmentShaderObj.compile();
		this.attachShader(vertexShaderObj, true);
		this.attachShader(fragmentShaderObj, true);
		this.link();
	}
	
	private void initProgram()
	{
		programId = glCreateProgram();
		ownedShaders = new ArrayList<Shader>();
	}
	
	@Override
	public int getId()
	{
		return programId;
	}
	
	@Override
	public void attachShader(Shader shader, boolean owned)
	{
		if (!shader.isCompiled())
		{
			throw new UncompiledShaderException("Shaders must be compiled before they can be attached to a program.");
		}
		else
		{
			glAttachShader(programId, shader.getId());
			if (owned)
			{
				ownedShaders.add(shader);
			}
		}
	}
	
	@Override
	public void detachShader(Shader shader)
	{
		glDetachShader(programId, shader.getId());
	}
	
	@Override
	public boolean isLinked()
	{
		int linked = glGetProgrami(programId, GL_LINK_STATUS);
    	return linked == GL_TRUE;
	}
	
	@Override
	public void link()
	{
    	glLinkProgram(programId);
    	if (!this.isLinked())
    	{
    		throw new ProgramLinkFailureException(glGetProgramInfoLog(programId));
    	}
	}
	
	@Override
	public void use()
	{
		if (!this.isLinked())
		{
			throw new UnlinkedProgramException("An OpenGL program cannot be used if it has not been linked.");
		}
		else
		{
			glUseProgram(programId);
		}
	}
	
	@Override
	public void delete()
	{
		glDeleteProgram(programId);
		for (Shader shader : ownedShaders)
		{
			shader.delete();
		}
	}
	
	@Override
	public int getUniformLocation(String name)
	{
		return glGetUniformLocation(programId, name);
	}
	
	@Override
	public void setUniform(int location, int value)
	{
		this.use(); glUniform1i(location, value);
	}
	
	@Override
	public void setUniform(int location, int value1, int value2)
	{
		this.use(); glUniform2i(location, value1, value2);
	}
	
	@Override
	public void setUniform(int location, int value1, int value2, int value3)
	{
		this.use(); glUniform3i(location, value1, value2, value3);
	}
	
	@Override
	public void setUniform(int location, int value1, int value2, int value3, int value4)
	{
		this.use(); glUniform4i(location, value1, value2, value3, value4);
	}

	@Override
	public void setUniform(int location, float value)
	{
		this.use(); glUniform1f(location, value);
	}
	
	@Override
	public void setUniform(int location, float value1, float value2)
	{
		this.use(); glUniform2f(location, value1, value2);
	}
	
	@Override
	public void setUniform(int location, float value1, float value2, float value3)
	{
		this.use(); glUniform3f(location, value1, value2, value3);
	}
	
	@Override
	public void setUniform(int location, float value1, float value2, float value3, float value4)
	{
		this.use(); glUniform4f(location, value1, value2, value3, value4);
	}

	@Override
	public void setUniform(int location, double value)
	{
		this.use(); glUniform1d(location, value);
	}
	
	@Override
	public void setUniform(int location, double value1, double value2)
	{
		this.use(); glUniform2d(location, value1, value2);
	}
	
	@Override
	public void setUniform(int location, double value1, double value2, double value3)
	{
		this.use(); glUniform3d(location, value1, value2, value3);
	}
	
	@Override
	public void setUniform(int location, double value1, double value2, double value3, double value4)
	{
		this.use(); glUniform4d(location, value1, value2, value3, value4);
	}
	
	@Override
	public void setUniform(String name, int value)
	{
		this.use(); glUniform1i(this.getUniformLocation(name), value);
	}
	
	@Override
	public void setUniform(String name, int value1, int value2)
	{
		this.use(); glUniform2i(this.getUniformLocation(name), value1, value2);
	}
	
	@Override
	public void setUniform(String name, int value1, int value2, int value3)
	{
		this.use(); glUniform3i(this.getUniformLocation(name), value1, value2, value3);
	}
	
	@Override
	public void setUniform(String name, int value1, int value2, int value3, int value4)
	{
		this.use(); glUniform4i(this.getUniformLocation(name), value1, value2, value3, value4);
	}

	@Override
	public void setUniform(String name, float value)
	{
		this.use(); glUniform1f(this.getUniformLocation(name), value);
	}
	
	@Override
	public void setUniform(String name, float value1, float value2)
	{
		this.use(); glUniform2f(this.getUniformLocation(name), value1, value2);
	}
	
	@Override
	public void setUniform(String name, float value1, float value2, float value3)
	{
		this.use(); glUniform3f(this.getUniformLocation(name), value1, value2, value3);
	}
	
	@Override
	public void setUniform(String name, float value1, float value2, float value3, float value4)
	{
		this.use(); glUniform4f(this.getUniformLocation(name), value1, value2, value3, value4);
	}

	@Override
	public void setUniform(String name, double value)
	{
		this.use(); glUniform1d(this.getUniformLocation(name), value);
	}
	
	@Override
	public void setUniform(String name, double value1, double value2)
	{
		this.use(); glUniform2d(this.getUniformLocation(name), value1, value2);
	}
	
	@Override
	public void setUniform(String name, double value1, double value2, double value3)
	{
		this.use(); glUniform3d(this.getUniformLocation(name), value1, value2, value3);
	}
	
	@Override
	public void setUniform(String name, double value1, double value2, double value3, double value4)
	{
		this.use(); glUniform4d(this.getUniformLocation(name), value1, value2, value3, value4);
	}
}
